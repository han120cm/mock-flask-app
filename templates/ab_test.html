{% extends "base.html" %}

{% block title %}Cache Policy A/B Test{% endblock %}

{% block content %}
<div class="container">
    <div class="header">
        <h1>üî¨ Cache Policy A/B Test</h1>
        <p>Compare performance of LRU, LFU, and LRB eviction policies</p>
    </div>
    
    <a href="{{ url_for('home') }}" class="back-button">‚Üê Back to Archive</a>
    
    <div class="section">
        <h2>üß™ Run A/B Test</h2>
        <form id="ab-test-form">
            <div class="form-group">
                <label for="cache_size">Cache Size (MB):</label>
                <input type="number" id="cache_size" name="cache_size" value="50" min="10" max="1000" class="form-control">
            </div>
            <div class="form-group">
                <label for="iterations">Number of Iterations:</label>
                <input type="number" id="iterations" name="iterations" value="3" min="1" max="20" class="form-control">
            </div>
            <button type="submit" id="run-test-btn" class="action-btn action-btn-upload">Run A/B Test</button>
        </form>
    </div>
    
    <div class="section">
        <h2>üìä Results</h2>
        <div id="test-results">
            <p>Run a test to see results here.</p>
        </div>
    </div>
</div>

<script>
    document.getElementById('ab-test-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const cacheSize = document.getElementById('cache_size').value;
        const iterations = document.getElementById('iterations').value;
        const runButton = document.getElementById('run-test-btn');
        const resultsDiv = document.getElementById('test-results');
        
        // Disable button and show loading
        runButton.disabled = true;
        runButton.textContent = 'Running Test...';
        resultsDiv.innerHTML = '<p>Running A/B test... This may take a moment.</p>';
        
        try {
            const response = await fetch('/api/run-ab-test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    cache_size_mb: parseInt(cacheSize),
                    num_iterations: parseInt(iterations)
                })
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                // Display results
                let html = `
                <h3>Summary Statistics</h3>
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Policy</th>
                            <th>Avg Hit Ratio</th>
                            <th>Avg Byte Hit Ratio</th>
                            <th>Items Evicted</th>
                            <th>Bytes Evicted (MB)</th>
                        </tr>
                    </thead>
                    <tbody>
                `;
                
                for (const [policy, stats] of Object.entries(data.summary)) {
                    html += `
                    <tr>
                        <td><strong>${policy}</strong></td>
                        <td>${stats.hit_ratio_mean.toFixed(4)}</td>
                        <td>${stats.byte_hit_ratio_mean.toFixed(4)}</td>
                        <td>${stats.items_evicted_mean.toFixed(2)}</td>
                        <td>${stats.bytes_evicted_mb_mean.toFixed(2)}</td>
                    </tr>
                    `;
                }
                
                html += `
                    </tbody>
                </table>
                
                <h3>Detailed Results</h3>
                <p>Total iterations: ${iterations}</p>
                <p>Cache size: ${cacheSize} MB</p>
                `;
                
                resultsDiv.innerHTML = html;
            } else {
                resultsDiv.innerHTML = `<p class="error">Error: ${data.error}</p>`;
            }
        } catch (error) {
            resultsDiv.innerHTML = `<p class="error">Error running test: ${error.message}</p>`;
        } finally {
            // Re-enable button
            runButton.disabled = false;
            runButton.textContent = 'Run A/B Test';
        }
    });
</script>

<style>
.results-table {
    width: 100%;
    border-collapse: collapse;
    margin: 20px 0;
}

.results-table th,
.results-table td {
    border: 1px solid #ddd;
    padding: 12px;
    text-align: left;
}

.results-table th {
    background-color: #f2f2f2;
    font-weight: bold;
}

.results-table tr:nth-child(even) {
    background-color: #f9f9f9;
}

.results-table tr:hover {
    background-color: #f5f5f5;
}

.error {
    color: #e74c3c;
    font-weight: bold;
}

.form-group {
    margin-bottom: 15px;
}

.form-control {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    box-sizing: border-box;
}
</style>
{% endblock %}