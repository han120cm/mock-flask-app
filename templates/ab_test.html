{% extends "base.html" %}

{% block title %}Cache Policy A/B Test{% endblock %}

{% block content %}
<div class="container">
    <div class="header">
        <h1>üî¨ Cache Policy A/B Test</h1>
        <p>Compare performance of LRU, LFU, and LRB eviction policies</p>
    </div>
    
    <a href="{{ url_for('home') }}" class="back-button">‚Üê Back to Archive</a>
    
    <div class="section">
        <h2>üß™ Run A/B Test</h2>
        <p>Click a button to start the A/B test for a specific region.</p>
        <div class="region-buttons">
            <button class="action-btn" onclick="runTest('sea')">Run Test on SEA</button>
            <button class="action-btn" onclick="runTest('eu')">Run Test on EU</button>
            <button class="action-btn" onclick="runTest('us')">Run Test on US</button>
        </div>
    </div>
    
    <div class="section">
        <h2>üìä Test Status & Logs</h2>
        <pre id="test-logs">No test running.</pre>
    </div>
</div>

<script>
    let intervalId;

    async function runTest(region) {
        const logContainer = document.getElementById('test-logs');
        logContainer.textContent = `Starting A/B test for ${region.toUpperCase()}...`;

        // Clear any previous polling
        if (intervalId) {
            clearInterval(intervalId);
        }

        try {
            const response = await fetch(`/test/run/${region}`);
            const data = await response.json();

            if (data.status === 'success') {
                logContainer.textContent = `Test for ${region.toUpperCase()} started successfully. Polling for logs...`;
                // Start polling for status
                intervalId = setInterval(() => fetchStatus(), 2000);
            } else {
                logContainer.textContent = `Error starting test: ${data.message}`;
            }
        } catch (error) {
            logContainer.textContent = `Error starting test: ${error.message}`;
        }
    }

    async function fetchStatus() {
        const logContainer = document.getElementById('test-logs');
        try {
            const response = await fetch('/test/status');
            const data = await response.json();

            if (data.status === 'success' || data.status === 'pending') {
                logContainer.textContent = data.log;
                // Check if the test is finished
                if (data.log.includes("All tests completed.") || data.log.includes("failed")) {
                    clearInterval(intervalId);
                }
            } else {
                logContainer.textContent = `Error fetching status: ${data.message}`;
                clearInterval(intervalId);
            }
        } catch (error) {
            logContainer.textContent = `Error fetching status: ${error.message}`;
            clearInterval(intervalId);
        }
    }
</script>

<style>
.region-buttons {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

#test-logs {
    background-color: #f5f5f5;
    border: 1px solid #ddd;
    padding: 15px;
    border-radius: 4px;
    white-space: pre-wrap;
    word-wrap: break-word;
    max-height: 500px;
    overflow-y: auto;
}
</style>
{% endblock %}